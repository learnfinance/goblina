<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>History - Sora Creator</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <style>
      :root {
        color-scheme: dark;
        --bg: #05060a;
        --panel: #111320;
        --accent: #5b8dff;
        --accent-soft: rgba(91, 141, 255, 0.2);
        --accent-green: #34d399;
        --accent-purple: #bf5af2;
        --border-subtle: #272b3f;
        --text-main: #f3f4ff;
        --text-muted: #9ca3c7;
        --danger: #f97373;
      }

      * { box-sizing: border-box; }

      body {
        margin: 0;
        font-family: system-ui, -apple-system, BlinkMacSystemFont, "SF Pro Text", sans-serif;
        background: radial-gradient(circle at top, #15182b 0, #05060a 55%);
        color: var(--text-main);
        min-height: 100vh;
      }

      /* Navigation */
      nav {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        background: rgba(17, 19, 32, 0.95);
        backdrop-filter: blur(10px);
        border-bottom: 1px solid rgba(91, 141, 255, 0.2);
        padding: 12px 24px;
        display: flex;
        align-items: center;
        gap: 24px;
        z-index: 1000;
      }

      nav a.logo {
        color: var(--text-main);
        text-decoration: none;
        font-weight: 600;
        font-size: 1.1rem;
      }

      nav .nav-links {
        display: flex;
        gap: 16px;
        flex: 1;
      }

      nav .nav-links a {
        color: var(--text-muted);
        text-decoration: none;
        padding: 6px 12px;
        border-radius: 8px;
        transition: all 0.2s;
      }

      nav .nav-links a:hover,
      nav .nav-links a.active {
        background: rgba(91, 141, 255, 0.1);
        color: var(--accent);
      }

      /* Main Container */
      .container {
        max-width: 1400px;
        margin: 0 auto;
        padding: 80px 24px 40px;
      }

      /* Header */
      .page-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 32px;
        flex-wrap: wrap;
        gap: 16px;
      }

      .page-header h1 {
        margin: 0;
        font-size: 2rem;
        display: flex;
        align-items: center;
        gap: 12px;
      }

      .page-header p {
        color: var(--text-muted);
        margin: 8px 0 0;
      }

      /* Tabs */
      .tabs {
        display: flex;
        gap: 8px;
        margin-bottom: 24px;
        border-bottom: 1px solid var(--border-subtle);
        padding-bottom: 16px;
      }

      .tab {
        padding: 10px 20px;
        border-radius: 10px;
        border: 1px solid var(--border-subtle);
        background: rgba(15, 23, 42, 0.6);
        color: var(--text-muted);
        cursor: pointer;
        transition: all 0.2s;
        font-size: 0.9rem;
      }

      .tab:hover {
        border-color: var(--accent);
        color: var(--text-main);
      }

      .tab.active {
        background: var(--accent-soft);
        border-color: var(--accent);
        color: var(--accent);
      }

      /* Buttons */
      .btn {
        border-radius: 999px;
        border: none;
        padding: 10px 20px;
        font-size: 0.9rem;
        font-weight: 500;
        cursor: pointer;
        display: inline-flex;
        align-items: center;
        gap: 8px;
        transition: all 0.2s;
      }

      .btn-primary {
        background: linear-gradient(135deg, #5b8dff, #bf5af2);
        color: #fff;
        box-shadow: 0 0 14px rgba(91, 141, 255, 0.5);
      }

      .btn-secondary {
        background: rgba(15, 23, 42, 0.85);
        color: var(--text-main);
        border: 1px solid var(--border-subtle);
      }

      .btn-danger {
        background: rgba(249, 115, 115, 0.15);
        color: var(--danger);
        border: 1px solid rgba(249, 115, 115, 0.3);
      }

      .btn-sm {
        padding: 6px 14px;
        font-size: 0.8rem;
      }

      /* Projects Grid */
      .projects-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
        gap: 20px;
      }

      .project-card {
        background: linear-gradient(145deg, #0a0e1a, #12162a);
        border-radius: 16px;
        border: 1px solid var(--border-subtle);
        overflow: hidden;
        transition: all 0.3s;
      }

      .project-card:hover {
        border-color: var(--accent);
        transform: translateY(-2px);
        box-shadow: 0 8px 32px rgba(91, 141, 255, 0.15);
      }

      .project-card .card-header {
        padding: 16px 20px;
        border-bottom: 1px solid var(--border-subtle);
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
      }

      .project-card h3 {
        margin: 0 0 4px;
        font-size: 1rem;
        display: flex;
        align-items: center;
        gap: 8px;
      }

      .project-card .badge {
        font-size: 0.65rem;
        padding: 3px 8px;
        border-radius: 999px;
        text-transform: uppercase;
      }

      .badge-personality {
        background: rgba(191, 90, 242, 0.2);
        color: var(--accent-purple);
        border: 1px solid rgba(191, 90, 242, 0.3);
      }

      .project-card .meta {
        color: var(--text-muted);
        font-size: 0.8rem;
      }

      .project-card .card-body {
        padding: 16px 20px;
      }

      .project-card .topic {
        color: var(--text-muted);
        font-size: 0.9rem;
        margin-bottom: 12px;
        line-height: 1.5;
      }

      .project-card .scenarios-preview {
        display: flex;
        flex-wrap: wrap;
        gap: 6px;
        margin-bottom: 16px;
      }

      .project-card .scenario-tag {
        font-size: 0.75rem;
        padding: 4px 10px;
        border-radius: 6px;
        background: rgba(91, 141, 255, 0.1);
        border: 1px solid rgba(91, 141, 255, 0.2);
        color: var(--text-muted);
        max-width: 200px;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
      }

      .project-card .card-actions {
        display: flex;
        gap: 8px;
      }

      /* Videos Grid */
      .videos-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
        gap: 20px;
      }

      .video-card {
        background: linear-gradient(145deg, #0a0e1a, #12162a);
        border-radius: 16px;
        border: 1px solid var(--border-subtle);
        overflow: hidden;
        transition: all 0.3s;
      }

      .video-card:hover {
        border-color: var(--accent);
        transform: translateY(-2px);
      }

      .video-card .video-thumbnail {
        aspect-ratio: 9/16;
        max-height: 300px;
        background: #000;
        display: flex;
        align-items: center;
        justify-content: center;
        position: relative;
      }

      .video-card video {
        width: 100%;
        height: 100%;
        object-fit: cover;
      }

      .video-card .status-overlay {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        padding: 12px 20px;
        border-radius: 12px;
        background: rgba(0, 0, 0, 0.8);
        color: var(--text-muted);
        font-size: 0.85rem;
      }

      .video-card .card-body {
        padding: 14px 16px;
      }

      .video-card .card-title {
        font-size: 0.85rem;
        margin: 0 0 8px;
        color: var(--text-main);
        display: -webkit-box;
        -webkit-line-clamp: 2;
        -webkit-box-orient: vertical;
        overflow: hidden;
      }

      .video-card .card-meta {
        display: flex;
        gap: 8px;
        flex-wrap: wrap;
        margin-bottom: 12px;
      }

      .video-card .chip {
        font-size: 0.7rem;
        padding: 3px 8px;
        border-radius: 999px;
        background: rgba(15, 23, 42, 0.9);
        border: 1px solid var(--border-subtle);
        color: var(--text-muted);
      }

      .video-card .chip.status-completed {
        border-color: var(--accent-green);
        color: var(--accent-green);
      }

      .video-card .chip.status-pending {
        border-color: #facc15;
        color: #facc15;
      }

      .video-card .chip.status-failed {
        border-color: var(--danger);
        color: var(--danger);
      }

      .video-card .card-actions {
        display: flex;
        gap: 6px;
      }

      .video-card .card-actions .btn {
        flex: 1;
        justify-content: center;
      }

      /* Empty State */
      .empty-state {
        text-align: center;
        padding: 80px 40px;
        background: rgba(15, 23, 42, 0.4);
        border-radius: 20px;
        border: 2px dashed var(--border-subtle);
      }

      .empty-state .icon {
        font-size: 4rem;
        margin-bottom: 20px;
        opacity: 0.5;
      }

      .empty-state h3 {
        margin: 0 0 12px;
        font-size: 1.4rem;
      }

      .empty-state p {
        color: var(--text-muted);
        margin: 0 0 24px;
      }

      .loading {
        text-align: center;
        padding: 40px;
        color: var(--text-muted);
      }

      /* Toast */
      .toast {
        position: fixed;
        bottom: 24px;
        right: 24px;
        background: var(--panel);
        border: 1px solid var(--border-subtle);
        border-radius: 12px;
        padding: 16px 20px;
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4);
        transform: translateY(100px);
        opacity: 0;
        transition: all 0.3s;
        z-index: 3000;
      }

      .toast.show {
        transform: translateY(0);
        opacity: 1;
      }

      .toast.success { border-color: var(--accent-green); }
      .toast.error { border-color: var(--danger); }

      /* Filters */
      .filters {
        display: flex;
        gap: 12px;
        flex-wrap: wrap;
      }

      .filter-select {
        padding: 8px 14px;
        border-radius: 10px;
        border: 1px solid var(--border-subtle);
        background: rgba(15, 23, 42, 0.9);
        color: var(--text-main);
        font-size: 0.85rem;
        cursor: pointer;
      }

      .filter-select:focus {
        border-color: var(--accent);
        outline: none;
      }
    </style>
  </head>
  <body>
    <!-- Navigation -->
    <nav>
      <a href="/home.html" class="logo">üé¨ Sora Creator</a>
      <div class="nav-links">
        <a href="/characters.html">üë§ My Characters</a>
        <a href="/history.html" class="active">üìú History</a>
        <a href="/templates.html">üìö Templates</a>
        <a href="/creator.html">üßô‚Äç‚ôÄÔ∏è Creator Wizard</a>
        <a href="/index.html">‚ö° Quick Generate</a>
      </div>
    </nav>

    <div class="container">
      <!-- Page Header -->
      <div class="page-header">
        <div>
          <h1>üìú Generation History</h1>
          <p>View your past projects and generated videos</p>
        </div>
        <div class="filters">
          <select class="filter-select" id="character-filter">
            <option value="">All Characters</option>
          </select>
          <select class="filter-select" id="status-filter">
            <option value="">All Status</option>
            <option value="completed">Completed</option>
            <option value="pending">Pending</option>
            <option value="failed">Failed</option>
          </select>
        </div>
      </div>

      <!-- Tabs -->
      <div class="tabs">
        <button class="tab active" data-tab="projects" onclick="switchTab('projects')">
          üìÅ Projects
        </button>
        <button class="tab" data-tab="videos" onclick="switchTab('videos')">
          üé• All Videos
        </button>
      </div>

      <!-- Projects Tab -->
      <div id="projects-tab">
        <div class="projects-grid" id="projects-grid"></div>
        <div class="empty-state" id="projects-empty" style="display: none;">
          <div class="icon">üìÅ</div>
          <h3>No Projects Yet</h3>
          <p>Create your first content project to see it here</p>
          <a href="/creator.html" class="btn btn-primary">üé¨ Start Creating</a>
        </div>
        <div class="loading" id="projects-loading">Loading projects...</div>
      </div>

      <!-- Videos Tab -->
      <div id="videos-tab" style="display: none;">
        <div class="videos-grid" id="videos-grid"></div>
        <div class="empty-state" id="videos-empty" style="display: none;">
          <div class="icon">üé•</div>
          <h3>No Videos Yet</h3>
          <p>Generate your first video to see it here</p>
          <a href="/creator.html" class="btn btn-primary">üé¨ Start Creating</a>
        </div>
        <div class="loading" id="videos-loading">Loading videos...</div>
      </div>
    </div>

    <!-- Toast -->
    <div class="toast" id="toast">
      <span id="toast-message"></span>
    </div>

    <script>
      let projects = [];
      let videos = [];
      let characters = [];
      let currentTab = 'projects';

      // Initialize
      document.addEventListener('DOMContentLoaded', async () => {
        await loadCharacters();
        await loadProjects();
        await loadVideos();
      });

      // Tab Switching
      function switchTab(tab) {
        currentTab = tab;
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        document.querySelector(`[data-tab="${tab}"]`).classList.add('active');

        document.getElementById('projects-tab').style.display = tab === 'projects' ? 'block' : 'none';
        document.getElementById('videos-tab').style.display = tab === 'videos' ? 'block' : 'none';
      }

      // Load Characters for Filter
      async function loadCharacters() {
        try {
          const res = await fetch('/api/characters');
          characters = await res.json();
          
          const select = document.getElementById('character-filter');
          characters.forEach(char => {
            const option = document.createElement('option');
            option.value = char.id;
            option.textContent = char.name;
            select.appendChild(option);
          });
        } catch (err) {
          console.error('Failed to load characters:', err);
        }
      }

      // Load Projects
      async function loadProjects() {
        const grid = document.getElementById('projects-grid');
        const empty = document.getElementById('projects-empty');
        const loading = document.getElementById('projects-loading');

        try {
          const characterId = document.getElementById('character-filter').value;
          const url = characterId ? `/api/projects?characterId=${characterId}` : '/api/projects';
          
          const res = await fetch(url);
          projects = await res.json();

          loading.style.display = 'none';

          if (projects.length === 0) {
            empty.style.display = 'block';
            grid.style.display = 'none';
          } else {
            empty.style.display = 'none';
            grid.style.display = 'grid';
            renderProjects();
          }
        } catch (err) {
          loading.innerHTML = '<span class="error-text">Failed to load projects</span>';
          console.error(err);
        }
      }

      function renderProjects() {
        const grid = document.getElementById('projects-grid');
        grid.innerHTML = '';

        projects.forEach(project => {
          const scenarios = typeof project.scenarios === 'string' 
            ? JSON.parse(project.scenarios) 
            : (project.scenarios || []);

          const scenariosList = Array.isArray(scenarios) ? scenarios : (scenarios.scenarios || []);
          const createdDate = new Date(project.created_at).toLocaleDateString();
          const personality = project.personality_preset || 'genz-meme';

          const card = document.createElement('div');
          card.className = 'project-card';
          card.innerHTML = `
            <div class="card-header">
              <div>
                <h3>
                  üìÅ ${project.character_name || 'Unknown Character'}
                  <span class="badge badge-personality">${personality.replace('-', ' ')}</span>
                </h3>
                <div class="meta">${createdDate}</div>
              </div>
            </div>
            <div class="card-body">
              <div class="topic">"${truncate(project.topic, 100)}"</div>
              <div class="scenarios-preview">
                ${scenariosList.slice(0, 3).map(s => `
                  <span class="scenario-tag">${truncate(s.hook || s.description || 'Scene', 30)}</span>
                `).join('')}
                ${scenariosList.length > 3 ? `<span class="scenario-tag">+${scenariosList.length - 3} more</span>` : ''}
              </div>
              <div class="card-actions">
                <button class="btn btn-secondary btn-sm" onclick="viewProject('${project.id}')">
                  üëÅÔ∏è View Details
                </button>
                <button class="btn btn-primary btn-sm" onclick="continueProject('${project.id}')">
                  ‚ñ∂Ô∏è Continue
                </button>
                <button class="btn btn-danger btn-sm" onclick="deleteProject('${project.id}')">
                  üóëÔ∏è
                </button>
              </div>
            </div>
          `;
          grid.appendChild(card);
        });
      }

      // Load Videos
      async function loadVideos() {
        const grid = document.getElementById('videos-grid');
        const empty = document.getElementById('videos-empty');
        const loading = document.getElementById('videos-loading');

        try {
          const res = await fetch('/api/videos');
          videos = await res.json();

          loading.style.display = 'none';

          // Apply status filter
          const statusFilter = document.getElementById('status-filter').value;
          let filtered = videos;
          if (statusFilter) {
            filtered = videos.filter(v => v.status === statusFilter);
          }

          if (filtered.length === 0) {
            empty.style.display = 'block';
            grid.style.display = 'none';
          } else {
            empty.style.display = 'none';
            grid.style.display = 'grid';
            renderVideos(filtered);
          }
        } catch (err) {
          loading.innerHTML = '<span class="error-text">Failed to load videos</span>';
          console.error(err);
        }
      }

      function renderVideos(videoList) {
        const grid = document.getElementById('videos-grid');
        grid.innerHTML = '';

        videoList.forEach(video => {
          const createdDate = new Date(video.created_at).toLocaleDateString();
          const statusClass = `status-${video.status}`;

          const card = document.createElement('div');
          card.className = 'video-card';
          card.innerHTML = `
            <div class="video-thumbnail">
              ${video.status === 'completed' && video.sora_job_id ? `
                <video controls playsinline preload="metadata">
                  <source src="/api/download/${video.sora_job_id}" type="video/mp4">
                </video>
              ` : `
                <div class="status-overlay">
                  ${video.status === 'pending' ? '‚è≥ Processing...' : 
                    video.status === 'failed' ? '‚ùå Failed' : 'üé¨ ' + video.status}
                </div>
              `}
            </div>
            <div class="card-body">
              <div class="card-title">${truncate(video.prompt || 'No prompt', 80)}</div>
              <div class="card-meta">
                <span class="chip ${statusClass}">${video.status}</span>
                <span class="chip">${createdDate}</span>
                ${video.duration_seconds ? `<span class="chip">${video.duration_seconds}s</span>` : ''}
              </div>
              <div class="card-actions">
                ${video.status === 'completed' ? `
                  <button class="btn btn-secondary btn-sm" onclick="downloadVideo('${video.sora_job_id}')">
                    ‚¨áÔ∏è Download
                  </button>
                  <button class="btn btn-primary btn-sm" onclick="remixVideo('${video.sora_job_id}')">
                    üîÑ Remix
                  </button>
                ` : `
                  <button class="btn btn-secondary btn-sm" disabled>
                    ${video.status === 'pending' ? '‚è≥ Processing...' : '‚ùå Failed'}
                  </button>
                `}
              </div>
            </div>
          `;
          grid.appendChild(card);
        });
      }

      // Filter handlers
      document.getElementById('character-filter').addEventListener('change', loadProjects);
      document.getElementById('status-filter').addEventListener('change', loadVideos);

      // Actions
      function viewProject(id) {
        const project = projects.find(p => p.id === id);
        if (!project) return;
        // Could open a modal or navigate to detail page
        alert(JSON.stringify(project, null, 2));
      }

      function continueProject(id) {
        localStorage.setItem('continueProjectId', id);
        window.location.href = '/creator.html';
      }

      async function deleteProject(id) {
        if (!confirm('Delete this project and all its videos?')) return;

        try {
          const res = await fetch(`/api/projects/${id}`, { method: 'DELETE' });
          if (!res.ok) throw new Error('Failed to delete');
          
          showToast('üóëÔ∏è Project deleted', 'success');
          loadProjects();
        } catch (err) {
          showToast('‚ùå ' + err.message, 'error');
        }
      }

      function downloadVideo(soraJobId) {
        window.open(`/api/download/${soraJobId}`, '_blank');
      }

      function remixVideo(soraJobId) {
        localStorage.setItem('remixVideoId', soraJobId);
        window.location.href = '/index.html';
      }

      // Utilities
      function truncate(str, len) {
        if (!str) return '';
        return str.length > len ? str.substring(0, len) + '...' : str;
      }

      function showToast(message, type = 'success') {
        const toast = document.getElementById('toast');
        document.getElementById('toast-message').textContent = message;
        toast.className = 'toast ' + type + ' show';
        setTimeout(() => toast.classList.remove('show'), 3000);
      }
    </script>
  </body>
</html>

